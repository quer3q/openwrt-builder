name: AX3000T AP

on:
  workflow_dispatch: {}
  # schedule:
  #   - cron: "01 12 */20 * *"

permissions:
  contents: write

concurrency:
  group: ax3000t-ap-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout OpenWrt
        uses: actions/checkout@v4
        with:
          repository: openwrt/openwrt
          ref: openwrt-25.12
          fetch-depth: 1

      - name: Free disk space
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Show disk usage (before)
        run: df -h

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential clang flex bison g++ gawk gcc-multilib gettext \
            git libncurses-dev libssl-dev python3 python3-setuptools python3-pyelftools \
            rsync unzip zlib1g-dev file wget curl ccache \
            device-tree-compiler xz-utils
          sudo apt-get clean

      - name: Cache downloads (dl/)
        uses: actions/cache@v4
        with:
          path: dl
          key: ${{ runner.os }}-openwrt-dl-${{ hashFiles('feeds.conf.default') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-openwrt-dl-${{ hashFiles('feeds.conf.default') }}-
            ${{ runner.os }}-openwrt-dl-

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ${{ runner.os }}-openwrt-ccache-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-openwrt-ccache-

      - name: Configure feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Generate config
        run: |
          cat > .config <<'EOF'
          # Target Info
          CONFIG_TARGET_mediatek=y
          CONFIG_TARGET_mediatek_filogic=y
          CONFIG_TARGET_mediatek_filogic_DEVICE_xiaomi_mi-router-ax3000t=y

          # Interface & Offloading Requirements
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_bridger=y
          CONFIG_PACKAGE_kmod-nft-offload=y

          # EBPF Requirements for Bridger
          CONFIG_PACKAGE_kmod-mt7915e=y
          CONFIG_PACKAGE_bpftool=y
          EOF

          make defconfig

          echo "===== .config (relevant, enabled only) ====="
          egrep -v '^[[:space:]]*#' .config | egrep "^(CONFIG_TARGET_|CONFIG_PACKAGE_(luci|bridger|kmod-nft-offload|kmod-mt7915e|bpftool)=)" || true

      - name: Inject WED Configuration
        run: |
          mkdir -p files/etc/modules.d
          echo "options mt7915e wed_enable=Y" > files/etc/modules.d/mt7915e

      - name: Download sources
        env:
          CCACHE_DIR: ${{ github.workspace }}/.ccache
        run: |
          make download -j"$(nproc)" || make download -j1 V=s

      - name: Build images
        env:
          CCACHE_DIR: ${{ github.workspace }}/.ccache
        run: |
          make -j"$(nproc)" || make -j1 V=s

      - name: TAR output
        run: tar -cvf ax3000t-images.tar bin/targets/mediatek/filogic/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ax3000t-images
          path: ax3000t-images.tar
          if-no-files-found: error
          retention-days: 14

      - name: Show disk usage (after)
        run: df -h

  release:
    name: Make a release
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: ax3000t-images

      - name: Extract artifacts
        run: tar xf ax3000t-images.tar

      - name: Get the current date
        run: echo "NOW=$(date +%F)" >> "$GITHUB_ENV"

      - name: Create a release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "ax3000t-ap-${{ env.NOW }}"
          name: "AX3000T v25.12 (AP)"
          prerelease: false
          generate_release_notes: false
          files: bin/targets/mediatek/filogic/*